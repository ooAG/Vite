<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard — Mini ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- small footprint CSS (Bootstrap used only for layout basics) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #f7f8fa;
      --card: #ffffff;
      --muted: #6e7682;
      --accent: #222;
    }
    html,body{height:100%}
    body{
      margin:0;
      padding:28px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color:#111;
    }

    /* layout container */
    .wrap{max-width:1100px;margin:0 auto}

    /* header */
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .hdr h1{margin:0;font-size:18px;font-weight:600}
    .hdr p{margin:0;color:var(--muted);font-size:13px}

    /* controls row */
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .controls select{min-width:180px;padding:.4rem .6rem;border-radius:6px;border:1px solid #e6e8eb;background:white}
    .controls button{padding:.35rem .6rem;border-radius:6px;border:1px solid #d0d4da;background:white;color:var(--accent)}
    .controls button.primary{background:#f3f4f6;border:1px solid #e6e8eb}

    /* metrics */
    #cards{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .metric{
      background:var(--card);
      border:1px solid #e9ecef;
      padding:12px 14px;
      border-radius:8px;
      min-width:160px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .metric .label{font-size:12px;color:var(--muted)}
    .metric .value{font-size:18px;font-weight:700;color:#111}

    /* chart and table cards */
    .panel{background:var(--card);border:1px solid #e9ecef;border-radius:8px;padding:12px}
    .panel h5{margin:0 0 8px 0;font-size:14px}

    table{width:100%;border-collapse:collapse}
    thead th{font-size:13px;color:#222;border-bottom:1px solid #eef0f2;text-align:left;padding:8px}
    tbody td{padding:8px;border-bottom:1px solid #f1f3f5;vertical-align:middle}
    .text-right{ text-align:right }

    /* small screens */
    @media (max-width:900px){
      #cards{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <div>
        <h1>Mini ERP Dashboard</h1>
        <p>Sales & inventory</p>
      </div>
      <div>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div id="error" style="display:none;margin-bottom:10px;color:#8b0000"></div>

    <div class="controls">
      <select id="categoryFilter" aria-label="Category filter">
        <option value="">All categories</option>
        <option value="Gadgets">Gadgets</option>
        <option value="Services">Services</option>
      </select>

      <button id="addSaleBtn" class="primary" style="display:none">Add</button>
      <button id="exportBtn" style="display:none">Export</button>

      <div style="margin-left:auto;color:var(--muted);font-size:13px" id="lastUpdated">Last updated: -</div>
    </div>

    <div id="cards" aria-hidden="false">
      <!-- metrics rendered here -->
    </div>

    <div class="panel" style="margin-bottom:12px">
      <h5>Sales by month</h5>
      <canvas id="salesChart" height="90" style="width:100%"></canvas>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h5 style="margin:0">Recent sales</h5>
        <div style="color:var(--muted);font-size:13px">Latest records</div>
      </div>

      <div style="max-height:360px;overflow:auto">
        <table id="salesTable">
          <thead>
            <tr><th>Date</th><th>Product</th><th>Category</th><th class="text-right">Amount</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Inline JS: preserved behavior, minimal UI only -->
  <script>
    // API base and token helpers
    if (typeof window.API_BASE === 'undefined') window.API_BASE = 'http://127.0.0.1:8000';

    function getToken(){
      return (localStorage.getItem('access_token') || localStorage.getItem('token') || '').replace(/\s/g,'');
    }

    async function apiGet(path){
      const token = getToken();
      const headers = {'Content-Type':'application/json'};
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, { headers });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText||res.status);
        throw new Error(txt || ('HTTP ' + res.status));
      }
      return res.json();
    }
    async function apiPostRaw(path, body){
      const token = getToken();
      return fetch(API_BASE + path, { method:'POST', headers:{ 'Content-Type':'application/json', ...(token?{Authorization:'Bearer '+token}:{}) }, body: JSON.stringify(body) });
    }
    async function apiPutRaw(path, body){
      const token = getToken();
      return fetch(API_BASE + path, { method:'PUT', headers:{ 'Content-Type':'application/json', ...(token?{Authorization:'Bearer '+token}:{}) }, body: JSON.stringify(body) });
    }
    async function apiDeleteRaw(path){
      const token = getToken();
      return fetch(API_BASE + path, { method:'DELETE', headers:{ ...(token?{Authorization:'Bearer '+token}:{}) } });
    }

    // state
    let isStaff = false;
    let currentCategory = '';
    let currentPage = 1;

    // basic UI helpers
    function showError(msg){
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.textContent = msg;
    }
    function hideError(){
      const e = document.getElementById('error');
      e.style.display = 'none';
      e.textContent = '';
    }

    // render metric cards
    function renderMetricCards(data){
      const container = document.getElementById('cards');
      container.innerHTML = '';
      const items = [
        { label: 'Total sales', value: '₹ ' + data.total_sales },
        { label: 'Total orders', value: data.total_orders },
        { label: 'Inventory', value: data.inventory_count }
      ];
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'metric';
        div.innerHTML = '<div class="label">' + it.label + '</div><div class="value">' + it.value + '</div>';
        container.appendChild(div);
      });
    }

    // load summary + chart
    async function loadSummaryAndChart(){
      try {
        hideError();
        const q = currentCategory ? '?category=' + encodeURIComponent(currentCategory) : '';
        const summary = await apiGet('/api/summary/' + q);

        renderMetricCards(summary);

        const months = (summary.monthly || []).map(m => m.month);
        const totals = (summary.monthly || []).map(m => m.total);

        const canvas = document.getElementById('salesChart');
        const ctx = canvas.getContext('2d');

        if (window.salesChart && typeof window.salesChart.destroy === 'function') {
          try { window.salesChart.destroy(); } catch(e){ /* ignore */ }
        }
        window.salesChart = null;

        if (months.length) {
          window.salesChart = new Chart(ctx, {
            type: 'line',
            data: { labels: months, datasets: [{ data: totals, tension: 0.3, borderWidth: 1.5, borderColor:'#111' }]},
            options: { responsive: true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
          });
        } else {
          ctx.clearRect(0,0,canvas.width,canvas.height);
        }

        const lu = document.getElementById('lastUpdated');
        if (lu) lu.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        showError(err.message || 'Failed to load summary');
      }
    }

    // load sales table
    async function loadSalesPage(page = 1){
      try {
        hideError();
        currentPage = page;
        const q = '?page=' + page + (currentCategory ? '&category=' + encodeURIComponent(currentCategory) : '');
        const data = await apiGet('/api/sales/' + q);
        const tbody = document.querySelector('#salesTable tbody');
        tbody.innerHTML = '';
        if (!data.results || data.results.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#7b8794">No records found</td></tr>';
          return;
        }
        data.results.forEach(r=>{
          const actions = isStaff
            ? '<button data-id="'+r.id+'" class="editBtn" style="margin-right:6px">Edit</button><button data-id="'+r.id+'" class="delBtn">Delete</button>'
            : '';
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + r.date + '</td><td>' + r.product + '</td><td>' + r.category + '</td><td class="text-right">₹ ' + r.amount + '</td><td style="text-align:right">' + actions + '</td>';
          tbody.appendChild(tr);
        });

        if (isStaff) {
          document.querySelectorAll('.editBtn').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.dataset.id;
              try {
                const rec = await apiGet('/api/sales/' + id + '/');
                const date = prompt('Date (YYYY-MM-DD):', rec.date); if (!date) return;
                const product = prompt('Product:', rec.product); if (!product) return;
                const category = prompt('Category:', rec.category); if (!category) return;
                const amount = prompt('Amount:', rec.amount); if (!amount) return;
                const res = await apiPutRaw('/api/sales/' + id + '/', { date, product, category, amount });
                if (!res.ok) { alert('Update failed'); return; }
                await loadSummaryAndChart(); await loadSalesPage(currentPage);
              } catch(e){ alert('Edit failed: ' + (e.message || e)); }
            });
          });

          document.querySelectorAll('.delBtn').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Delete this sale?')) return;
              const id = btn.dataset.id;
              try {
                const res = await apiDeleteRaw('/api/sales/' + id + '/');
                if (!res.ok) { alert('Delete failed'); return; }
                await loadSummaryAndChart(); await loadSalesPage(currentPage);
              } catch(e){ alert('Delete failed: ' + (e.message || e)); }
            });
          });
        } else {
          // ensure no leftover buttons
          document.querySelectorAll('.editBtn, .delBtn').forEach(n=>n.remove());
        }
      } catch (err) {
        console.error(err);
        showError(err.message || 'Failed to load sales');
      }
    }

    // UI bindings
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); localStorage.removeItem('token');
      location.href = 'index.html';
    });

    document.getElementById('addSaleBtn').addEventListener('click', async ()=>{
      if (!isStaff) return;
      const date = prompt('Date (YYYY-MM-DD):', new Date().toISOString().slice(0,10)); if (!date) return;
      const product = prompt('Product:', 'New Item'); if (!product) return;
      const category = prompt('Category:', 'Gadgets'); if (!category) return;
      const amount = prompt('Amount:', '100.00'); if (!amount) return;
      const res = await apiPostRaw('/api/sales/', { date, product, category, amount });
      if (!res.ok) { alert('Add failed: ' + await res.text().catch(()=>res.statusText||'error')); return; }
      await loadSummaryAndChart(); await loadSalesPage(1);
    });

    document.getElementById('exportBtn').addEventListener('click', async ()=>{
      if (!isStaff) return;
      const q = currentCategory ? ('?category=' + encodeURIComponent(currentCategory)) : '';
      const url = API_BASE + '/api/sales/export/' + q;
      const token = getToken();
      try {
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token }});
        if (!res.ok) { alert('Export failed: ' + await res.text().catch(()=>res.statusText||'error')); return; }
        const blob = await res.blob();
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sales_export.csv';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      } catch (e) { alert('Export failed: ' + (e.message || e)); }
    });

    document.getElementById('categoryFilter').addEventListener('change', async (e)=>{
      currentCategory = e.target.value;
      await loadSummaryAndChart();
      await loadSalesPage(1);
    });

    // initialization
    (async function init(){
      try {
        const token = getToken();
        if (!token) return location.href = 'index.html';

        // hide controls until role is known
        document.getElementById('addSaleBtn').style.display = 'none';
        document.getElementById('exportBtn').style.display = 'none';

        let me = null;
        try { me = await apiGet('/api/me/'); } catch(e) { console.warn('whoami failed', e); me = null; }
        isStaff = !!(me && me.is_staff === true);

        if (isStaff) {
          document.getElementById('addSaleBtn').style.display = '';
          document.getElementById('exportBtn').style.display = '';
        } else {
          document.getElementById('addSaleBtn').style.display = 'none';
          document.getElementById('exportBtn').style.display = 'none';
        }

        await loadSummaryAndChart();
        await loadSalesPage(1);

        setInterval(async ()=>{ await loadSummaryAndChart(); await loadSalesPage(currentPage); }, 12000);
      } catch (e) {
        console.error('init error', e);
        try { localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); localStorage.removeItem('token'); } catch(_){}
        location.href = 'index.html';
      }
    })();
  </script>
</body>
</html>
